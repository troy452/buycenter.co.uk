<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BuyCenter | AliExpress Deals</title>
<style>
  body { margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f4f5f7; color:#333; }
  a { text-decoration:none; color:inherit; }
  header { background:linear-gradient(90deg,#e52e06,#ff6b35); color:white; padding:1rem 2rem; display:flex; flex-direction:column; align-items:center; gap:0.5rem; }
  header h1 { margin:0; font-size:2rem; }
  #search-bar { display:flex; width:100%; max-width:600px; gap:0.5rem; }
  #search-bar input { flex:1; padding:0.7rem 1rem; border-radius:5px 0 0 5px; border:none; font-size:1rem; }
  #search-bar button { padding:0.7rem 1.2rem; border:none; border-radius:0 5px 5px 0; background:#fff; color:#e52e06; font-weight:bold; cursor:pointer; transition:0.2s; }
  #search-bar button:hover { background:#ffe6dc; }
  main { display:flex; padding:2rem; gap:2rem; flex-wrap:wrap; }
  #filters { flex:0 0 220px; background:#fff; border-radius:12px; padding:1rem; box-shadow:0 2px 10px rgba(0,0,0,0.1); height:fit-content; display:flex; flex-direction:column; gap:1rem; }
  #filters h3 { margin:0 0 0.5rem 0; font-size:1.1rem; color:#e52e06; }
  #filters button { width:100%; padding:0.5rem; border:none; border-radius:8px; background:#f2f2f2; cursor:pointer; transition:0.2s; }
  #filters button:hover { background:#e52e06; color:white; }
  #filters label { font-size:0.9rem; margin-bottom:0.3rem; }
  #filters input[type="range"], #filters select { width:100%; }
  #categoryTab { display:none; flex-direction:column; gap:0.3rem; margin-top:0.5rem; }
  #categoryTab button { background:#f9f9f9; padding:0.4rem; font-size:0.9rem; border:none; cursor:pointer; transition:0.2s; }
  #categoryTab button:hover { background:#e52e06; color:white; }
  #products { flex:1; display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:1.5rem; }
  .product { background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; }
  .product:hover { transform: translateY(-5px) scale(1.03); box-shadow:0 6px 18px rgba(0,0,0,0.15); }
  .product img { width:100%; height:180px; object-fit:cover; transition:transform 0.3s; }
  .product:hover img { transform: scale(1.05); }
  .product-details { padding:0.7rem 1rem 1rem 1rem; }
  .product-details p { font-size:0.95rem; margin:0.3rem 0; height:45px; overflow:hidden; }
  .price { color:#e52e06; font-weight:bold; font-size:1rem; }
  #notice { max-width:900px; margin:0.6rem auto; font-size:0.9rem; color:#444; text-align:center; }
  @media(max-width:900px){ main{flex-direction:column; padding:1rem;} #filters{flex-direction:row; overflow-x:auto; width:100%; gap:0.5rem;} #filters button{flex:1 0 auto;} }
  @media(max-width:600px){ #search-bar{flex-direction:column;} #search-bar input,#search-bar button{width:100%; border-radius:8px;} #search-bar button{margin-top:0.5rem;} }
</style>
</head>
<body>

<header>
  <h1>BuyCenter</h1>
  <div id="search-bar">
    <input type="text" id="query" placeholder="Search products..." value="trending">
    <button id="searchBtn">Search</button>
  </div>
  <div id="notice">
    Live products via <strong>Cloudflare Worker</strong>. Affiliate links included.
  </div>
</header>

<main>
  <aside id="filters">
    <h3>Categories</h3>
    <button id="catToggle">Categories</button>
    <div id="categoryTab"></div>

    <h3>Price</h3>
    <label>Max: $<span id="priceValue">100</span></label>
    <input type="range" id="priceRange" min="1" max="1000" value="100">

    <h3>Sort</h3>
    <select id="sort">
      <option value="default">Default</option>
      <option value="low">Price: Low to High</option>
      <option value="high">Price: High to Low</option>
    </select>
  </aside>

  <section id="products">Loading products...</section>
</main>

<script>
// ========== CONFIG ==========
const WORKER_URL = 'https://aliexpress-proxy.your-subdomain.workers.dev'; // your Cloudflare Worker URL
let currentPage = 1;
let currentQuery = "trending";
let allProducts = [];
const categories = ["Women's Clothing","Men's Clothing","Consumer Electronics","Home & Garden","Beauty & Health","Toys & Hobbies","Sports & Entertainment","Automobiles & Motorcycles","Luggage & Bags","Jewelry & Watches"];
// ============================

// UI wiring
document.getElementById('catToggle').addEventListener('click', toggleCategories);
document.getElementById('searchBtn').addEventListener('click', searchProducts);
document.getElementById('priceRange').addEventListener('input', e=>updatePrice(e.target.value));
document.getElementById('sort').addEventListener('change', e=>sortProducts(e.target.value));

function toggleCategories(){
  const tab = document.getElementById("categoryTab");
  if(tab.style.display==="flex"){ tab.style.display="none"; return; }
  tab.innerHTML = "";
  categories.forEach(cat=>{
    const btn = document.createElement('button');
    btn.textContent = cat;
    btn.onclick = ()=>{ document.getElementById('query').value = cat; searchProducts(); };
    tab.appendChild(btn);
  });
  tab.style.display = "flex";
}

function updatePrice(value){
  document.getElementById('priceValue').textContent = value;
  document.querySelectorAll('.product').forEach(p=>{
    const price = parseFloat(p.dataset.price) || 0;
    p.style.display = price <= value ? 'block' : 'none';
  });
}

function sortProducts(type){
  if(type==="default") return;
  const container = document.getElementById('products');
  Array.from(container.querySelectorAll('.product'))
    .sort((a,b)=> type==='low' ? parseFloat(a.dataset.price)-parseFloat(b.dataset.price) : parseFloat(b.dataset.price)-parseFloat(a.dataset.price))
    .forEach(p=>container.appendChild(p));
}

function searchProducts(){
  currentQuery = document.getElementById('query').value.trim() || "trending";
  currentPage = 1;
  allProducts = [];
  fetchProducts(currentQuery, currentPage);
}

async function fetchProducts(query="trending", page=1){
  const container = document.getElementById('products');
  container.innerHTML = '<p>Loading productsâ€¦</p>';

  try {
    const res = await fetch(`${WORKER_URL}?query=${encodeURIComponent(query)}&page=${page}`);
    const data = await res.json();
    const items = data?.result?.products || [];
    if(page===1) allProducts = items; else allProducts = allProducts.concat(items);
    displayProducts(allProducts);
  } catch(err){
    console.error('Worker fetch failed:', err);
    container.innerHTML = '<p>Unable to load products live. See console for details.</p>';
  }
}

function displayProducts(items){
  const container = document.getElementById('products');
  if(!items || items.length===0){ container.innerHTML='<p>No products found.</p>'; return; }
  container.innerHTML = items.map(item=>{
    const title = item.productTitle || 'Unnamed Product';
    const price = parseFloat(item.salePrice) || 0;
    const img = item.imageUrl || 'https://via.placeholder.com/400x300?text=No+Image';
    const link = item.productUrl || '#';
    return `<div class="product" data-price="${price}">
      <a href="${link}" target="_blank" rel="noopener noreferrer">
        <img src="${img}" alt="${escapeHtml(title)}" loading="lazy">
        <div class="product-details">
          <p>${escapeHtml(title)}</p>
          <div class="price">$${price}</div>
        </div>
      </a>
    </div>`;
  }).join('');
  updatePrice(document.getElementById("priceRange").value);
  sortProducts(document.getElementById("sort").value);
}

// Utility to escape HTML
function escapeHtml(text){ return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// Infinite scroll
window.addEventListener("scroll", ()=>{
  if(window.innerHeight + window.scrollY >= document.body.offsetHeight-500){
    currentPage++;
    fetchProducts(currentQuery, currentPage);
  }
});

// Initial load
fetchProducts();
</script>
</body>
</html>
